{% extends "core/_base.html" %}
{% load static %}

{% block title %}–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞: –∫–ª–∏–µ–Ω—Ç {{ obj.id }}{% endblock %}

{% block head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"/>
  <style>
    .hw-home { font-size: 20px; }
    .hw-work { font-size: 20px; }

    /* –°–∫—Ä—ã—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–π —Ñ–ª–∞–≥ –≤ –∞—Ç—Ä–∏–±—É—Ü–∏–∏ Leaflet (–µ—Å–ª–∏ –æ–Ω –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∏–∑ —Å—Ç–∏–ª–µ–π/–ø–ª–∞–≥–∏–Ω–æ–≤) */
    .leaflet-attribution-flag { display: none !important; }
  </style>
{% endblock %}

{% block body %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="d-flex align-items-center gap-2">
    <a href="/clients/" class="btn btn-outline-secondary btn-sm">‚Üê –ö–æ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º</a>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/clients/">–ö–ª–∏–µ–Ω—Ç—ã</a></li>
        <li class="breadcrumb-item"><a href="{% url 'client-detail' obj.id %}">#{{ obj.id }}</a></li>
        <li class="breadcrumb-item active mono" aria-current="page">–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞</li>
      </ol>
    </nav>
  </div>
  <div class="d-flex align-items-center gap-2">
    <a class="btn btn-outline-secondary btn-sm{% if request.GET.period == '7d' %} active{% endif %}" href="?period=7d">7–¥</a>
    <a class="btn btn-outline-secondary btn-sm{% if request.GET.period == '30d' %} active{% endif %}" href="?period=30d">30–¥</a>
    <a class="btn btn-outline-secondary btn-sm{% if request.GET.period == '90d' %} active{% endif %}" href="?period=90d">90–¥</a>
    <a class="btn btn-outline-secondary btn-sm{% if request.GET.period == 'all' %} active{% endif %}" href="?period=all">–í—Å—ë</a>
  </div>
</div>

<div class="row g-4">
  <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ñ–∏–ª—å—Ç—Ä—ã -->
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header">
        <div class="fw-semibold">–§–∏–ª—å—Ç—Ä—ã</div>
      </div>
      <div class="card-body">
        <form id="filters" class="d-grid gap-3">
          <input type="hidden" id="clientId" value="{{ obj.ac_client_hash }}"/>

          <div>
            <label class="form-label mb-1">–ü–µ—Ä–∏–æ–¥ (–ø—Ä–µ—Å–µ—Ç)</label>
            <select name="period" class="form-select">
              <option value="">‚Äî</option>
              <option value="7d" {% if request.GET.period == '7d' %}selected{% endif %}>7 –¥–Ω–µ–π</option>
              <option value="30d" {% if request.GET.period == '30d' %}selected{% endif %}>30 –¥–Ω–µ–π</option>
              <option value="90d" {% if request.GET.period == '90d' %}selected{% endif %}>90 –¥–Ω–µ–π</option>
              <option value="all" {% if request.GET.period == 'all' %}selected{% endif %}>–≤—Å—ë –≤—Ä–µ–º—è</option>
            </select>
            <div class="form-text">–ò–ª–∏ —É–∫–∞–∂–∏ –¥–∞—Ç—ã –≤—Ä—É—á–Ω—É—é –Ω–∏–∂–µ</div>
          </div>

          <div>
            <label class="form-label mb-1">–ü–µ—Ä–∏–æ–¥ (—Å)</label>
            <input type="datetime-local" name="datetime_from" class="form-control"/>
          </div>

          <div>
            <label class="form-label mb-1">–ü–µ—Ä–∏–æ–¥ (–ø–æ)</label>
            <input type="datetime-local" name="datetime_to" class="form-control"/>
          </div>

          <div>
            <label class="form-label mb-1">–°–æ–±—ã—Ç–∏—è (–¥–ª—è —Ç–µ–ø–ª–æ–∫–∞—Ä—Ç—ã)</label>
            <select name="events" class="form-select" multiple size="3">
              <option value="Login Success" selected>Login Success</option>
              <option value="Authorization Success">Authorization Success</option>
              <option value="Start Auth Timer">Start Auth Timer</option>
            </select>
            <div class="form-text">–î–æ–º/—Ä–∞–±–æ—Ç–∞ –≤—Å–µ–≥–¥–∞ —Å—á–∏—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –≤—Ö–æ–¥–∞–º (Login/Authorization)</div>
          </div>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="toggleHomeWork">
            <label class="form-check-label" for="toggleHomeWork">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–æ–º/—Ä–∞–±–æ—Ç—É</label>
          </div>

          <div>
            <label class="form-label mb-1">–õ–∏–º–∏—Ç —Ç–æ—á–µ–∫</label>
            <input type="number" name="limit" class="form-control" value="20000" min="1000" max="100000"/>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button type="button" id="resetBtn" class="btn btn-outline-secondary">–°–±—Ä–æ—Å</button>
          </div>

          <div id="meta" class="form-text"></div>
          <div id="hwMeta" class="form-text"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∫–∞—Ä—Ç–∞ -->
  <div class="col-lg-8">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div class="fw-semibold">–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
        <a href="{% url 'client-detail' obj.id %}" class="btn btn-sm btn-outline-secondary">‚Üê –í –∫–∞—Ä—Ç–æ—á–∫—É –∫–ª–∏–µ–Ω—Ç–∞</a>
      </div>
      <div class="card-body">
        <div id="map" class="rounded" style="height:70vh;"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script>
    let map, heatLayer, homeMarker, workMarker;
    const MAX_ZOOM = 19;

    // –ë–∞–∑–æ–≤—ã–µ –ø–æ–¥–ª–æ–∂–∫–∏ (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ö–æ—Å—Ç–æ–≤ –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫)
    const baseLayers = {
      'OSM': L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: MAX_ZOOM,
        attribution: '¬© OpenStreetMap'
      }),
      'OSM HOT': L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
        maxZoom: MAX_ZOOM,
        attribution: '¬© OpenStreetMap contributors, style HOT'
      }),
      'Carto Light': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: MAX_ZOOM,
        attribution: '¬© OpenStreetMap, ¬© CARTO'
      })
    };

    function initMap() {
      // –û—Ç–∫–ª—é—á–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∞—Ç—Ä–∏–±—É—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ–π –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞
      map = L.map('map', { minZoom: 3, maxZoom: MAX_ZOOM, attributionControl: false })
              .setView([55.751244, 37.618423], 10);

      L.control.attribution({ prefix: '' }).addTo(map);

      // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–¥–ª–æ–∂–∫–∞ ‚Äî –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è OSM
      baseLayers['OSM'].addTo(map);

      // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–æ–¥–ª–æ–∂–µ–∫
      L.control.layers(baseLayers, {}).addTo(map);

      map.on('zoomend', () => {
        if (!heatLayer) return;
        const z = map.getZoom();
        const opt = heatOptionsForZoom(z);
        heatLayer.setOptions(opt);
      });
    }

    function heatOptionsForZoom(z) {
      if (z >= 18) return { radius: 10, blur: 8, maxZoom: 18 };
      if (z >= 16) return { radius: 14, blur: 10, maxZoom: 18 };
      return { radius: 18, blur: 12, maxZoom: 18 };
    }

    function buildHeatUrl() {
      const params = new URLSearchParams();
      const cid = document.getElementById('clientId')?.value;
      if (cid) params.set('client_id', cid);

      const form = document.getElementById('filters');
      const fields = ['period','datetime_from','datetime_to','limit'];
      for (const name of fields) {
        const el = form.elements[name];
        if (!el) continue;
        const v = el.value;
        if (v !== null && v !== '') params.set(name, v);
      }

      const evSel = form.elements['events'];
      if (evSel && evSel.selectedOptions) {
        Array.from(evSel.selectedOptions).forEach(opt => {
          params.append('events', opt.value);
        });
      }

      return '/api/geo/heatmap/?' + params.toString();
    }

    function buildHomeWorkUrl() {
      const params = new URLSearchParams();
      const cid = document.getElementById('clientId')?.value;
      if (cid) params.set('client_id', cid);

      const form = document.getElementById('filters');
      const fields = ['period','datetime_from','datetime_to'];
      for (const name of fields) {
        const el = form.elements[name];
        if (!el) continue;
        const v = el.value;
        if (v !== null && v !== '') params.set(name, v);
      }

      // –î–æ–º/—Ä–∞–±–æ—Ç–∞ –Ω–∞ –±—ç–∫–µ –≤—Å–µ–≥–¥–∞ –ø–æ Login/Authorization, events –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º
      return '/api/geo/homework/?' + params.toString();
    }

    function renderHeat(pts) {
      const opt = heatOptionsForZoom(map.getZoom());
      if (heatLayer) map.removeLayer(heatLayer);
      heatLayer = L.heatLayer(pts, opt).addTo(map);
    }

    function clearHomeWork() {
      if (homeMarker) { map.removeLayer(homeMarker); homeMarker = null; }
      if (workMarker) { map.removeLayer(workMarker); workMarker = null; }
      document.getElementById('hwMeta').textContent = '';
    }

    function renderHomeWork(home, work, features) {
      clearHomeWork();
      const show = document.getElementById('toggleHomeWork').checked;
      if (!show) return;

      const homeIcon = L.divIcon({ className: 'hw-home', html: 'üè†', iconSize: [24,24], iconAnchor: [12,12] });
      const workIcon = L.divIcon({ className: 'hw-work', html: 'üíº', iconSize: [24,24], iconAnchor: [12,12] });

      let texts = [];

      if (home && home.lat && home.lon) {
        homeMarker = L.marker([home.lat, home.lon], { icon: homeIcon })
          .bindPopup(`
            <b>–î–æ–º (–≥–∏–ø–æ—Ç–µ–∑–∞)</b><br/>
            –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(home.confidence*100).toFixed(0)}%<br/>
            –ù–∞–±–ª—é–¥–µ–Ω–∏–π: ${home.size}<br/>
            –ü–æ—Å–ª–µ–¥–Ω–µ–µ: ${home.last_seen ? new Date(home.last_seen).toLocaleString() : '‚Äî'}
          `)
          .addTo(map);
        texts.push(`–î–æ–º: ${(home.confidence*100).toFixed(0)}%, ${home.size} –Ω–∞–±–ª—é–¥–µ–Ω–∏–π`);
      }

      if (work && work.lat && work.lon) {
        workMarker = L.marker([work.lat, work.lon], { icon: workIcon })
          .bindPopup(`
            <b>–†–∞–±–æ—Ç–∞ (–≥–∏–ø–æ—Ç–µ–∑–∞)</b><br/>
            –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(work.confidence*100).toFixed(0)}%<br/>
            –ù–∞–±–ª—é–¥–µ–Ω–∏–π: ${work.size}<br/>
            –ü–æ—Å–ª–µ–¥–Ω–µ–µ: ${work.last_seen ? new Date(work.last_seen).toLocaleString() : '‚Äî'}
          `)
          .addTo(map);
        texts.push(`–†–∞–±–æ—Ç–∞: ${(work.confidence*100).toFixed(0)}%, ${work.size} –Ω–∞–±–ª—é–¥–µ–Ω–∏–π`);
      }

      const f = features || {};
      const counts = f.counts || {};
      const hourly = f.hourly_activity || [];
      const weekday = f.weekday_activity || [];

      let peakHour = null, peakHourVal = -1;
      hourly.forEach((v, h) => { if (v > peakHourVal) { peakHourVal = v; peakHour = h; } });

      let peakDay = null, peakDayVal = -1;
      weekday.forEach((v, d) => { if (v > peakDayVal) { peakDayVal = v; peakDay = d; } });

      const dayNames = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
      const peakDayName = (peakDay !== null && peakDay !== undefined) ? dayNames[peakDay] : '‚Äî';

      texts.push(`–°–æ–±—ã—Ç–∏–π: –≤—Å–µ–≥–æ ${counts.total || 0}, –Ω–æ—á—å ${counts.night || 0}, —Ä–∞–±–æ—á–µ–µ ${counts.work || 0}`);
      if (peakHour !== null) texts.push(`–ü–∏–∫ —á–∞—Å–∞: ${peakHour}:00`);
      if (peakDay !== null) texts.push(`–ü–∏–∫ –¥–Ω—è: ${peakDayName}`);

      document.getElementById('hwMeta').textContent = texts.join(' ¬∑ ');
    }

    async function loadHeat(url) {
      try {
        const res = await fetch(url, { credentials: 'same-origin' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();

        document.getElementById('meta').textContent =
          `–¢–æ—á–µ–∫: ${data.count || 0}` + (data.truncated ? ' (—Å—Ä–µ–∑–∞–Ω–æ –ø–æ –ª–∏–º–∏—Ç—É)' : '');

        const pts = data.heat_points || [];
        renderHeat(pts);

        if (pts.length > 0) {
          const latlngs = pts.map(p => L.latLng(p, p[11]));
          const bounds = L.latLngBounds(latlngs);
          if (bounds.isValid()) {
            if (bounds.getNorthWest().equals(bounds.getSouthEast())) {
              map.setView(bounds.getCenter(), 14);
            } else {
              map.fitBounds(bounds.pad(0.1));
            }
          }
        }
      } catch (err) {
        document.getElementById('meta').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (err?.message || err);
        console.error(err);
      }
    }

    async function loadHomeWork(url) {
      if (!document.getElementById('toggleHomeWork').checked) {
        clearHomeWork();
        return;
      }
      try {
        const res = await fetch(url, { credentials: 'same-origin' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        renderHomeWork(data.home, data.work, data.features);
      } catch (err) {
        document.getElementById('hwMeta').textContent = '–û—à–∏–±–∫–∞ HW: ' + (err?.message || err);
        console.error(err);
      }
    }

    function resetForm() {
      document.getElementById('filters').reset();
    }

    document.addEventListener('DOMContentLoaded', () => {
      initMap();

      const reloadAll = () => {
        loadHeat(buildHeatUrl());
        loadHomeWork(buildHomeWorkUrl());
      };

      reloadAll();

      document.getElementById('filters').addEventListener('submit', (e) => {
        e.preventDefault();
        reloadAll();
      });

      document.getElementById('resetBtn').addEventListener('click', () => {
        resetForm();
        reloadAll();
      });

      document.getElementById('toggleHomeWork').addEventListener('change', () => {
        loadHomeWork(buildHomeWorkUrl());
      });
    });
  </script>
{% endblock %}
