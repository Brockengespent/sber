{% extends "core/_base.html" %}
{% load static %}

{% block title %}–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã{% endblock %}

{% block head %}
  <style>
    .page-title { font-weight: 700; }
    .htmx-indicator { display: none; }
    .htmx-request .htmx-indicator { display: inline-block; }
  </style>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
{% endblock %}

{% block body %}
  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ –∫—Ä–æ—à–∫–∏ –≤ —Å—Ç–∏–ª–µ client_detail -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <a href="{% url 'index' %}" class="btn btn-outline-secondary btn-sm">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item"><a href="{% url 'index' %}">–ì–ª–∞–≤–Ω–∞—è</a></li>
          <li class="breadcrumb-item active mono" aria-current="page">–ö–ª–∏–µ–Ω—Ç—ã</li>
        </ol>
      </nav>
    </div>
    <div class="d-flex align-items-center gap-2">
      <a href="{% url 'upload_multi' %}" class="btn btn-outline-primary btn-sm">üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</a>
    </div>
  </div>

  <h1 class="page-title mb-3">üë• –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</h1>

  <div class="row g-4">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ñ–∏–ª—å—Ç—Ä—ã -->
    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-header">
          <div class="fw-semibold">–§–∏–ª—å—Ç—Ä—ã</div>
        </div>
        <div class="card-body">
          <form id="filters" class="d-grid gap-3">
            <div>
              <label class="form-label">–î–æ–ª–≥ –æ—Ç (‚ÇΩ)</label>
              <input id="inp-debt-min" type="number" step="1" min="0" class="form-control" name="debt_min" placeholder="0">
            </div>

            <div>
              <label class="form-label">–î–æ–ª–≥ –¥–æ (‚ÇΩ)</label>
              <input id="inp-debt-max" type="number" step="1" min="0" class="form-control" name="debt_max" placeholder="1000000">
            </div>

            <div>
              <label class="form-label">–ü—Ä–æ—Å—Ä–æ—á–∫–∞</label>
              <select class="form-select" name="bucket" id="bucket-select" multiple></select>
              <div class="form-text">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Cmd/Ctrl –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞</div>
            </div>

            <div>
              <label class="form-label">–ì–æ—Ä–æ–¥</label>
              <select class="form-select" name="city" id="city-select">
                <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
                {% if cities %}
                  {% for c in cities %}
                    <option value="{{ c }}" {% if c == selected_city %}selected{% endif %}>{{ c }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>

            <div class="d-flex gap-2">
              <!-- –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã -->
              <button type="button"
                      class="btn btn-primary"
                      hx-get="{% url 'clients_table' %}"
                      hx-target="#clients-table"
                      hx-include="#filters"
                      hx-indicator="#loading">
                –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
              </button>

              <!-- –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Å–±—Ä–æ—Å -->
              <button id="reset-btn" type="reset"
                      class="btn btn-outline-secondary"
                      hx-get="{% url 'clients_table' %}"
                      hx-target="#clients-table"
                      hx-vals="{}"
                      hx-indicator="#loading"
                      hx-trigger="click">
                –°–±—Ä–æ—Å–∏—Ç—å
              </button>
            </div>

            <div id="loading" class="htmx-indicator">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
          </form>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ç–∞–±–ª–∏—Ü–∞ -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="fw-semibold">–¢–∞–±–ª–∏—Ü–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-dark"
                    hx-get="{% url 'clients_table' %}?ordering=-total_debt"
                    hx-target="#clients-table"
                    hx-include="#filters"
                    hx-indicator="#loading">
              –î–æ–ª–≥ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
            </button>
            <button class="btn btn-sm btn-outline-dark"
                    hx-get="{% url 'clients_table' %}?ordering=total_debt"
                    hx-target="#clients-table"
                    hx-include="#filters"
                    hx-indicator="#loading">
              –î–æ–ª–≥ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é
            </button>
          </div>
        </div>
        <div class="card-body p-0">
          <div id="clients-table"
               hx-get="{% url 'clients_table' %}"
               hx-trigger="load"
               hx-indicator="#loading">
            <!-- —Å—é–¥–∞ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç core/partials/clients_table.html -->
            <div class="p-3 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã‚Ä¶</div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      // 1) –ü–æ–¥–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–∞–∫–µ—Ç–æ–≤
      try {
        const resp = await fetch("{% url 'clients_buckets' %}");
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        const buckets = Array.isArray(data.buckets) ? data.buckets : [];
        const sel = document.getElementById('bucket-select');
        sel.innerHTML = '';
        buckets.forEach(b => {
          const opt = document.createElement('option');
          opt.value = b;
          opt.textContent = b;
          sel.appendChild(opt);
        });
      } catch (e) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–∞–∫–µ—Ç–æ–≤ –ø—Ä–æ—Å—Ä–æ—á–∫–∏', e);
        const sel = document.getElementById('bucket-select');
        if (sel && !sel.options.length) {
          ['0', '180+'].forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.textContent = b;
            sel.appendChild(opt);
          });
        }
      }

      // 2) –ü–æ–ª–Ω—ã–π –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å–±—Ä–æ—Å + –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
      const form = document.getElementById('filters');
      const resetBtn = document.getElementById('reset-btn');
      resetBtn.addEventListener('click', function () {
        // —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
        form.reset();
        // –æ—á–∏—Å—Ç–∫–∞ –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç–æ–≤ –∏ –∏–Ω–ø—É—Ç–æ–≤
        form.querySelectorAll('select').forEach(sel => {
          for (const opt of sel.options) opt.selected = false;
          sel.selectedIndex = -1;
        });
        form.querySelectorAll('input[type="number"], input[type="text"]').forEach(inp => inp.value = '');

        // –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        htmx.ajax('GET', "{% url 'clients_table' %}", {
          target: '#clients-table',
          indicator: '#loading',
          values: {},
        });
      });
    });
  </script>
{% endblock %}
